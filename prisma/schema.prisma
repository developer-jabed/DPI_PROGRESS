generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===================== ENUMS =====================
enum Department {
  CIVIL
  COMPUTER
  ARCHITECTURE
  MECHANICAL
  ELECTRICAL
  POWER
}

enum Group {
  A
  B
}

enum Shift {
  DAY
  MORNING
}

enum AttendanceStatus {
  DRAFT
  PRESENT
  ABSENT
  VACATION
  SICK
  OTHER
}

enum UserRole {
  STUDENT
  TEACHER
  ADMIN
  CR
}

enum PointRecordType {
  EXTRA_MARK
  PENALTY
  QUIZ
  CLASS_TEST
  PRACTICAL
  OTHER
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum SessionStatus {
  SCHEDULED
  CANCELLED
  COMPLETED
}

// ===================== SEMESTER MODEL =====================
model Semester {
  id               String               @id @default(uuid())
  name             String               @unique
  shift            Shift

  batches          Batch[]
  students         Student[]
  crs              CR[]
  attendances      AttendanceRecord[]
  points           StudentPointRecord[]
  exams            ExamSchedule[]
  attendanceAudits AttendanceAudit[]
  examResults      ExamResult[]
}

// ===================== USERS =====================
model User {
  id                 String     @id @default(uuid())
  email              String?    @unique
  password           String
  displayName        String?
  role               UserRole   @default(STUDENT)
  status             UserStatus @default(ACTIVE)
  needPasswordChange Boolean    @default(true)
  profileUrl         String?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @default(now()) @updatedAt

  student Student? @relation("UserStudent")
  teacher Teacher? @relation("UserTeacher")
  cr      CR?      @relation("UserCr")
  admin   Admin?   @relation("UserAdmin")

  notices          Notice[]          @relation("NoticePostedBy")
  notifications    Notification[]    @relation("NotificationUser")
  attendanceAudits AttendanceAudit[] @relation("ChangedBy")
}

// ===================== ADMIN =====================
model Admin {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation("UserAdmin", fields: [userId], references: [id])

  profileUrl  String?
  phoneNumber String?
  designation String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

// ===================== BATCH =====================
model Batch {
  id         String     @id @default(uuid())
  name       String
  department Department
  group      Group
  shift      Shift

  semesterId String? // note the ?
  semester   Semester? @relation(fields: [semesterId], references: [id])

  cr CR? @relation("BatchCr")

  students      Student[]
  examSchedules ExamSchedule[]
  sessions      ClassSession[]
}

// ===================== STUDENT =====================
model Student {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation("UserStudent", fields: [userId], references: [id])

  rollNumber   String @unique
  registration String @unique

  semesterId String
  semester   Semester @relation(fields: [semesterId], references: [id])

  phoneNumber  String
  parentsPhone String

  batchId String
  batch   Batch  @relation(fields: [batchId], references: [id])

  attendances  AttendanceRecord[]
  pointRecords StudentPointRecord[]
  examResults  ExamResult[]
  progress     StudentProgress[]

  firstLogin Boolean @default(true)

  cr CR? @relation("StudentCr")
}

// ===================== CR =====================
model CR {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation("UserCr", fields: [userId], references: [id])

  studentId String  @unique
  student   Student @relation("StudentCr", fields: [studentId], references: [id])

  batchId String @unique
  batch   Batch  @relation("BatchCr", fields: [batchId], references: [id])

  semesterId String
  semester   Semester @relation(fields: [semesterId], references: [id])
}

// ===================== TEACHER =====================
model Teacher {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation("UserTeacher", fields: [userId], references: [id])

  department  Department
  phoneNumber String?
  bio         String?
  profileUrl  String?

  attendanceMarked AttendanceRecord[]   @relation("TeacherMarkedAttendance")
  classes          ClassSession[]       @relation("TeacherClasses")
  givenPoints      StudentPointRecord[]
}

// ===================== CLASS SESSION =====================
model ClassSession {
  id      String @id @default(uuid())
  batchId String
  batch   Batch  @relation(fields: [batchId], references: [id])

  date   DateTime
  status SessionStatus @default(SCHEDULED)

  teacherId String?
  teacher   Teacher? @relation("TeacherClasses", fields: [teacherId], references: [id])

  attendance AttendanceRecord[]
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @default(now()) @updatedAt
}

// ===================== ATTENDANCE =====================
model AttendanceRecord {
  id String @id @default(uuid())

  sessionId String
  session   ClassSession @relation(fields: [sessionId], references: [id])

  studentId String
  student   Student @relation(fields: [studentId], references: [id])

  semesterId String
  semester   Semester @relation(fields: [semesterId], references: [id])

  markedById String
  markedBy   Teacher @relation("TeacherMarkedAttendance", fields: [markedById], references: [id])

  status AttendanceStatus @default(DRAFT)
  reason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  audits AttendanceAudit[] @relation("AttendanceAuditRecord")
}

model AttendanceAudit {
  id String @id @default(uuid())

  attendanceId String
  attendance   AttendanceRecord @relation("AttendanceAuditRecord", fields: [attendanceId], references: [id])

  semesterId String
  semester   Semester @relation(fields: [semesterId], references: [id])

  changedById String
  changedBy   User   @relation("ChangedBy", fields: [changedById], references: [id])

  changeType    String
  previousValue AttendanceStatus?
  newValue      AttendanceStatus?
  reason        String?

  createdAt DateTime @default(now())
}

// ===================== STUDENT POINT RECORD =====================
model StudentPointRecord {
  id        String  @id @default(uuid())
  studentId String
  student   Student @relation(fields: [studentId], references: [id])

  teacherId String
  givenBy   Teacher @relation(fields: [teacherId], references: [id])

  semesterId String
  semester   Semester @relation(fields: [semesterId], references: [id])

  type      PointRecordType
  points    Float
  reason    String?
  createdAt DateTime        @default(now())
}

// ===================== NOTICES & NOTIFICATIONS =====================
model Notice {
  id    String @id @default(uuid())
  title String
  body  String

  postedById String
  postedBy   User   @relation("NoticePostedBy", fields: [postedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model Notification {
  id    String  @id @default(uuid())
  title String
  body  String
  read  Boolean @default(false)

  userId String
  user   User   @relation("NotificationUser", fields: [userId], references: [id])

  createdAt DateTime @default(now())
}

// ===================== EXAMS & PROGRESS =====================
model ExamSchedule {
  id      String @id @default(uuid())
  batchId String
  batch   Batch  @relation(fields: [batchId], references: [id])

  semesterId String
  semester   Semester @relation(fields: [semesterId], references: [id])

  subject String
  date    DateTime

  examResults ExamResult[]
}

model ExamResult {
  id         String   @id @default(uuid())
  semesterId String
  semester   Semester @relation(fields: [semesterId], references: [id])

  studentId String
  student   Student @relation(fields: [studentId], references: [id])

  examId       String
  examSchedule ExamSchedule @relation(fields: [examId], references: [id])

  marks Float
}

model StudentProgress {
  id String @id @default(uuid())

  studentId String
  student   Student @relation(fields: [studentId], references: [id])

  progress String
}

// ===================== EVENT GALLERY =====================
model EventGallery {
  id          String   @id @default(uuid())
  title       String
  description String
  image       String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
}
